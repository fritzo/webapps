<!DOCTYPE html>
<html>
<head>
<title>Live Coder</title>
<!-- ------------------------------------------------------------------------ -->
<script type='text/javascript' src='jquery.js'></script>
<script type='text/javascript' src='modernizr.js'></script>
<script type='text/javascript' src='jquery.timeago.js'></script>
<script type='text/javascript'>

'use strict';

function AssertException(message) {
  this.message = message;
}
AssertException.prototype.toString = function () {
  return 'Assertion Failed: ' + this.message;
}
function assert (condition, message) {
  if (!condition) {
    throw new AssertException(message);
  }
}

function localStorage_keys () {
  var keys = new Array(localStorage.length);
  for (var i = 0, I = localStorage.length; i < I; ++i) {
    keys[i] = localStorage.key(i);
  }
  return keys;
}

//------------------------------------------------------------------------------
// Live

var live = {};

live.logo = [
  "",
  "// this is just an example",
  "var c = live.draw2d();",
  "c.font = 'bold 64pt Courier';",
  "c.fillStyle = '#77ff77';",
  "c.fillText(' LiveCoder', 0, c.canvas.height/2);",
  ""
].join('\n');

live.log = function (message) {
  $('#log').val(String(message));
};

//------------------------------------------------------------------------------
// User

live.setUser = function (user) {
  if (user == undefined) {
    user = 'anonymous';
  }

  var pattern = /^[a-zA-Z0-9_-]+$/;
  if ((user.length <= 40) && pattern.test(user)) {
    live.user = user;
    localStorage.setItem('user', user);
    $('#username').html(user);
  } else {
    alert('invalid username. try <=40 alphanumeric characters plus _-');
  }
};

//------------------------------------------------------------------------------
// Evaluation

// TODO switch from textarea to tree editor

live.evalSource = function () {
  source = $('#source');

  try {
    live.log('');
    eval(source.val());
    source.css('color', '#77ff77');
  }
  catch (err) {
    source.css('color', '#ff7777');
    live.log('error: ' + String(err));
  }
};

live.liveEvalSource = function () {
  var source = $('#source');

  if ($('#if_live').is(':checked')) {
    source.on('keyup', live.evalSource).trigger('keyup');
  }
  else {
    source.off('keyup');
  }
};

//------------------------------------------------------------------------------
// Persistence

live.getStoredScripts = function () {
  return localStorage_keys().filter(function (key) {
    return /^script\.[0-9]+\.[a-zA-Z0-9_-]+$/.test(key);
  });
};

live.getScriptListHeader = function (size) {
  var create = function (tag) { return $(document.createElement(tag)); };

  return create('tr').append(
      create('td').append(
          create('button').html('delete all').on('click', live.deleteScripts)),
      create('td').attr('colspan','3').html(
          String(size) + ' scripts are saved locally'));
};

live.getScriptLink = function (key) {
  var create = function (tag) { return $(document.createElement(tag)); };

  var loadScript = function () {
    $('#source').val(localStorage.getItem(key)).trigger('keyup');
  };
  var deleteScript = function () {
    localStorage.removeItem(key);
    live.listScripts();
  };
  
  var tr = create('tr');

  tr.append(create('td')
      .append(create('button').html('load').on('click', loadScript))
      .append(create('button').html('delete').on('click', deleteScript)));

  var script_time_user = key.split('.');

  var time = Number(script_time_user[1]);
  var timeago = $.timeago(new Date(time));
  tr.append(create('td').html(timeago));

  var user = script_time_user[2];
  tr.append(create('td').html(user));

  var fullSource = localStorage.getItem(key);
  var briefSource = fullSource.replace(/\s+/g, ' ').substr(0,60) + '...';
  var toggleBrevityOfChildren = function () {
    $(this).children().each(function (index, element) {
          element = $(element);
          if (element.css('display') == 'none') {
            element.css('display', 'inline');
          } else {
            element.css('display', 'none');
          }
        });
  };
  tr.append(create('td')
        .on('click', toggleBrevityOfChildren)
        .append(create('code').css('display', 'inline').html(briefSource))
        .append(create('pre')
            .css('display', 'none')
            .append(create('code').html(fullSource))));
  return tr;
};

live.listScripts = function () {

  var keys = live.getStoredScripts();
  keys.sort();
  keys.reverse();

  var menu = $('#scriptList')
  menu.empty();
  menu.append(live.getScriptListHeader(keys.length));
  for (var i = 0; i < keys.length; ++i) {
    var key = keys[i];
    menu.append(live.getScriptLink(key));
  }
};

live.saveScript = function () {
  var name = ['script', String(Date.now()), live.user].join('.');
  live.log('saving ' + name + ' ...');
  localStorage.setItem(name, $('#source').val());
  live.listScripts();
  live.log('');
};

live.deleteScripts = function () {

  if (confirm('Really delete all scripts in local storage?')) {
    var keys = live.getStoredScripts();
    for (var i = 0, I = keys.length; i < I; ++i) {
      localStorage.removeItem(keys[i]);
    }

    live.listScripts();
  }
};

//------------------------------------------------------------------------------
// Hiding the editor

live.showEditor = function () {
  $('#showEditor').css('display', 'none');
  $('textarea').css('display', 'block');
  $('#toolbar').css('display', 'block');
  $('#source').focus();
};

live.hideEditor = function () {
  $('textarea').css('display', 'none');
  $('#toolbar').css('display', 'none');
  $('#showEditor').css('display', 'block');
};

//------------------------------------------------------------------------------
// Graphics

live.draw2d = function () {
  var context = live.context2d;
  context.clearRect(0, 0, context.canvas.width, context.canvas.height);
  return context;
};

live.resize = function () {

  live.context2d.canvas.width = window.innerWidth;
  live.context2d.canvas.height = window.innerHeight;

  if ($('#if_live').is(':checked')) {
    live.evalSource();
  }
};

//------------------------------------------------------------------------------
// Main

live.assertFeatures = function () {
  var has = Modernizr;
  assert(has.canvas, 'Browser does not support canvas element');
  assert(has.opacity, 'Browser does not support opacity');
  assert(has.rgba, 'Browser does not support rgba() color attributes');
  assert(has.localstorage, 'Browser does not support localStorage');
  assert(has.webworkers, 'Browser does not support Web Workers');
  //assert(has.svg, 'Browser does not support svg');
  //assert(has.audio, 'Browser does not support audio element');
};

$(document).ready(function() {

  try { live.assertFeatures(); }
  catch (e) {
    var message = $(document.createElement('h1'))
      .html(String(e))
      .attr('class','warning');
    $(document.body).empty().html(message);
    return;
  }

  $(window).resize(live.resize);

  $('#source').text(live.logo);

  $('#eval').on('click', live.evalSource);
  $('#if_live').on('change', live.liveEvalSource).trigger('change');

  $('#save').on('click', live.saveScript);

  // google plus
  if (window.location.origin == 'http://livecoder.net') {
    var po = document.createElement('script');
    po.type = 'text/javascript';
    po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(po, s);
  } else {
    $('.g-plusone').css('display','none');
  }

  $('#setUser').on('click', function () {
    var user = prompt('What name will you use?')
    if (user != undefined) {
      live.setUser(user);
    }
  });

  live.setUser(localStorage.getItem('user'));

  live.listScripts();

  try {
    live.context2d = document.getElementById('canvas2d').getContext('2d');
    assert(live.context2d, 'failed to get 2d canvas context');
  }
  catch (e) {
    live.log(e);
  }

  live.resize();

  var inIframe = window.location != window.parent.location;
  if (inIframe) {
    live.hideEditor();
    $('body').on('click', function(){
      live.showEditor();
      $('body').off('click');
    });
  } else {
    live.showEditor();
  }
});

</script>
<!-- ------------------------------------------------------------------------ -->
<style>

body {
  font-family: helvetica, verdana, sans;
  color: white;
  background-color: black;

  width:  100%;
  height: 100%;
  margin: 0px;
}

.warning { color: red; }

canvas {
  position: absolute; 
  top: 0px;
  left: 0px;
}
 
textarea {
  font-weight: bold;
  font-size: x-large;
  background-color: rgba(0,0,0,0);
  text-shadow: 0ex 0ex 1ex rgba(0,0,0,1);
  opacity: 0.333;

  position: absolute;
  margin: 0px;
  padding: 0px;
  border: 0px;
  outline: none;
  resize: none;
  overflow: hidden;
}
#source {
  width: 100%;
  height: 85%;
  top: 0px;
  left: 0px;
  color: #77ff77;
}
#log {
  width: 100%;
  height: 15%;
  bottom: 0px;
  left: 0px;
  color: #ffff00;
}

#toolbar,
#showEditor {
  position: absolute;
  width: 100%;
  bottom: 0px; /* hack for 100% - 2ex */
  opacity: 0.8;
}
button {
  color: white;
  background-color: #444444;
  border-color: #222222;
}
button:hover {
  color: white;
  background-color: #555555;
  border-color: #r3;
}
#scriptList {
  height: 11ex;
  overflow: auto;
}
#toolbar table {
  display: none;
}
#toolbar:hover table {
  display: block;
}

#scriptList tr td {
  padding: 0px 0.25em 0px 0.25em;
  vertical-align: top;
}
#scriptList tr td code {
  color: gray;
}
#scriptList tr td pre code {
  color: white;
}

/* back-to-front */
canvas { z-index: 1; }
textarea { z-index: 2; }
#toolbar { z-index: 3; }
#showEditor { z-index: 3; }

</style>
</head>
<!-- ------------------------------------------------------------------------ -->
<body>

<canvas id='canvas2d'></canvas>

<textarea id='source' rows=23 cols=50></textarea>
<textarea id='log' rows=2 cols=50 readonly></textarea>

<div id='toolbar'>
  <table id='scriptList'> </table>

  <button onclick='live.hideEditor();'>hide</button>
  |
  <input type='checkbox' id='if_live' checked /> live
  <button id='eval'>eval</button>
  |
  <button id='save'>save</button>
  |
  <button id='setUser'>user</button>
  <span id='username'></span>
  |
  <a href='about.html'><button>about</button></a>
</div>
</div>

<div id='showEditor'>
  <button onclick='live.showEditor();'>+</button>
</div>

</body>
</html>

