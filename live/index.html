<!DOCTYPE html>
<html>
<head>
<title>Live Coder</title>
<!-- ------------------------------------------------------------------------ -->
<script type='text/javascript' src='jquery.js'></script>
<script type='text/javascript' src='jquery.timeago.js'></script>
<script type='text/javascript'>

function AssertException(message) {
  this.message = message;
}
AssertException.prototype.toString = function () {
  return 'AssertException: ' + this.message;
}
function assert (condition, message) {
  if (!condition) {
    throw new AssertException(message);
  }
}

function localStorage_keys () {
  var keys = new Array(localStorage.length);
  for (var i = 0, I = localStorage.length; i < I; ++i) {
    keys[i] = localStorage.key(i);
  }
  return keys;
}

//------------------------------------------------------------------------------
// Live

var live = {};

// TODO replace this with code to draw the logo on the background
live.logo =
"// _     _             ____           _           \n" +
"//| |   (_)__   _____ / ___| ___   __| | ___ _ __ \n" +
"//| |   | |\\ \\ / / _ \\ |    / _ \\ / _` |/ _ \\ '__|\n" +
"//| |___| | \\ V /  __/ |___| (_) | (_| |  __/ |   \n" +
"//|_____|_|  \\_/ \\___|\\____|\\___/ \\__,_|\\___|_|.net";

window.log = function (message) {
  $('#log').val(message);
}
window.print = function (message) {
  $('#result').val(message);
}

//------------------------------------------------------------------------------
// User

live.setUser = function (user) {
  if (user == undefined) {
    user = 'anonymous';
  }

  var pattern = /^[a-zA-Z0-9_-]+$/;
  if ((user.length <= 40) && pattern.test(user)) {
    live.user = user;
    localStorage.setItem('user', user);
    $('#username').html(user);
  } else {
    alert('invalid username. try <=40 alphanumeric characters plus _-');
  }
}

//------------------------------------------------------------------------------
// Evaluation

live.safeEval = function () {
  source = $('#source');

  try {
    print(JSON.stringify(eval(source.val())));
    source.css('background-color', '#eeffee');
    log('');
  }
  catch (err) {
    source.css('background-color', '#ffeeee');
    log('error: ' + String(err));
  }
};

live.liveEval = function () {
  source = $('#source');

  if ($('#if_live').is(':checked')) {
    source.on('keyup', live.safeEval).trigger('keyup');
  }
  else {
    source.off('keyup');
  }
};

//------------------------------------------------------------------------------
// Persistence

live.getStoredScripts = function () {
  return localStorage_keys().filter(function (key) {
    return /^script\.[0-9]+\.[a-zA-Z0-9_-]+$/.test(key);
  });
}

live.getScriptLink = function (key) {

  var loadScript = function () {
    $('#source').val(localStorage.getItem(key)).trigger('keyup');
  };
  var deleteScript = function () {
    localStorage.removeItem(key);
    live.listScripts();
  };

  var tr = $(document.createElement('tr'));

  tr.append($(document.createElement('td'))
      .append($(document.createElement('button'))
          .html('load')
          .on('click', loadScript))
      .append($(document.createElement('button'))
          .html('delete')
          .on('click', deleteScript)));

  script_time_user = key.split('.');

  time = Number(script_time_user[1]);
  timeago = $.timeago(new Date(time));
  tr.append($(document.createElement('td')).html(timeago));

  user = script_time_user[2];
  tr.append($(document.createElement('td')).html(user));

  var fullSource = localStorage.getItem(key);
  var briefSource = fullSource.replace(/\s+/g, ' ').substr(0,60) + '...';
  var toggleBrevityOfChildren = function () {
    $(this).children().each(function (index, element) {
          element = $(element);
          if (element.css('display') == 'none') {
            element.css('display', 'inline');
          } else {
            element.css('display', 'none');
          }
        });
  };
  tr.append($(document.createElement('td'))
        .on('click', toggleBrevityOfChildren)
        .append($(document.createElement('code'))
            .css('display', 'inline')
            .html(briefSource))
        .append($(document.createElement('pre'))
            .css('display', 'none')
            .append($(document.createElement('code'))
                .html(fullSource))));
  return tr;
}

live.listScripts = function () {

  var keys = live.getStoredScripts();
  keys.sort();
  keys.reverse();

  var menu = $('#scriptList')
  menu.empty();
  for (var i = 0; i < keys.length; ++i) {
    var key = keys[i];
    menu.append(live.getScriptLink(key));
  }
};

live.saveScript = function () {
  var name = ['script', String(Date.now()), live.user].join('.');
  log('storing ' + name);
  localStorage.setItem(name, $('#source').val());
  live.listScripts();
};

live.deleteScripts = function () {

  if (confirm('Really delete all scripts in local storage?')) {
    var keys = live.getStoredScripts();
    for (var i = 0, I = keys.length; i < I; ++i) {
      localStorage.removeItem(keys[i]);
    }

    live.listScripts();
  }
};

//------------------------------------------------------------------------------
// Main

$(document).ready(function() {

  $('#source').text(live.logo);

  $('#eval').on('click', live.safeEval);
  $('#if_live').on('change', live.liveEval).trigger('change');

  $('#save').on('click', live.saveScript);
  $('#deleteAll').on('click', live.deleteScripts);

  // google plus
  if (window.location.origin == 'http://livecoder.net') {
    var po = document.createElement('script');
    po.type = 'text/javascript';
    po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(po, s);
  } else {
    $('.g-plusone').css('display','none');
  }

  $('#setUser').on('click', function () {
    var user = prompt('What name will you use?')
    if (user != undefined) {
      live.setUser(user);
    }
  });

  live.setUser(localStorage.getItem('user'));

  live.listScripts();

  $('#paypal').css('display', 'none');
});

</script>
<!-- ------------------------------------------------------------------------ -->
<style>

body {
  font-family: helvetica, verdana, sans;
}

#source { background-color: #eeffee; }
#result { background-color: #eeeeee; }
#log { background-color: #ffffee; }

#scriptList tr td {
  padding: 0px 0.25em 0px 0.25em;
  vertical-align: top;
}
#scriptList tr td code {
  color: gray;
}
#scriptList tr td pre code {
  color: black;
}

</style>
</head>
<!-- ------------------------------------------------------------------------ -->
<body>

<div class='code'>
  <table>
    <tr>
      <td>
        <textarea id='source' rows=23 cols=50> </textarea>
      </td>
      <td>
        <textarea id='result' rows=20 cols=50 readonly> </textarea>
        <textarea id='log' rows=2 cols=50 readonly> </textarea>
      </td>
    </tr>
  </table>
</div>

<div class='toolbar'>
  <input type='checkbox' id='if_live' checked /> live
  <button id='eval'>eval</button>
  |
  <button id='save'>save</button>
  <button id='deleteAll'>delete all</button>
  |
  <button id='setUser'>user</button>
  <span id='username'></span>
  |
  <a href='about.html'><button>about</button></a>
</div>

<div>
  <table id='scriptList'>
  </table>
</div>

</body>
</html>

