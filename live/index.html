<!DOCTYPE html>
<html>
<head>
<title>Live Coder</title>
<!-- ------------------------------------------------------------------------ -->
<script type='text/javascript' src='jquery.min.js'></script> <!-- MIT,GPL -->
<script type='text/javascript' src='jquery.timeago.js'></script> <!-- MIT -->
<script type='text/javascript' src='modernizr.js'></script> <!-- MIT,BSD -->
<script type='text/javascript' src='livecoder.js'></script> <!-- MIT -->
<script type='text/javascript' src='riffwave.js'></script> <!-- GPL -->
<script type='text/javascript'>

var live = livecoder;
var ui = {};

//------------------------------------------------------------------------------
// Persistence

ui.getStoredScripts = function () {

  var keys = new Array(localStorage.length);
  for (var i = 0, I = localStorage.length; i < I; ++i) {
    keys[i] = localStorage.key(i);
  }

  return keys.filter(function (key) {
    return /^[0-9]+\.js$/.test(key);
  });
};

ui.getScriptLink = function (key) {
  var create = function (tag) { return $(document.createElement(tag)); };

  var loadScript = function () {
    live.reset();
    live.setSource(localStorage.getItem(key))
    $('#source').trigger('keyup');
  };
  var deleteScript = function () {
    localStorage.removeItem(key);
    ui.listScripts();
  };
  
  var tr = create('tr');

  tr.append(create('td')
      .append(create('button')
          .html('delete').attr('class','roundFlat')
          .click(function(){
            tr.fadeOut('fast', deleteScript);
          }))
      .append(create('button')
          .html('load').attr('class','flatRound')
          .click(loadScript)));

  var time_js = key.split('.');
  var time = Number(time_js[0]);
  var timeago = $.timeago(new Date(time));
  tr.append(create('td')
        .html(timeago)
        .attr('title', 'click to load')
        .click(loadScript));

  var fullSource = $.trim(localStorage.getItem(key));
  var briefSource = fullSource.replace(/\s+/g, ' ').substr(0,60) + '...';

  var brief = create('pre')
    .append(create('code').text(briefSource))
    .attr('title', 'click to expand')
    .show();
  var full = create('pre')
    .append(create('code').text(fullSource))
    .attr('title', 'click to collapse')
    .hide();

  tr.append(create('td')
      .append(brief, full)
      .click(function(){
            brief.slideToggle(50);
            full.slideToggle(150);
          }));
  return tr;
};

ui.listScripts = function () {

  var keys = ui.getStoredScripts();
  keys.sort();
  keys.reverse();

  $('#showGallery').html('gallery (' + keys.length + ')');

  // TODO FIXME script list extends above top of page
  var menu = $('#gallery');
  menu.empty();
  for (var i = 0; i < keys.length; ++i) {
    var key = keys[i];
    menu.append(ui.getScriptLink(key));
  }
};

ui.saveScript = function () {
  var name = String(Date.now()) + '.js';
  localStorage.setItem(name, live.getSource());
  ui.listScripts();
  live.log('saved ' + name + ' ...');
};

ui.deleteScripts = function () {

  if (confirm('Really delete all codes in local storage?')) {
    var keys = ui.getStoredScripts();
    for (var i = 0, I = keys.length; i < I; ++i) {
      localStorage.removeItem(keys[i]);
    }

    ui.listScripts();
  }
};

//------------------------------------------------------------------------------
// Hash persistence

ui.getHash = function () {
  var hashedSource = encodeURIComponent(live.getSource());
  return window.location.href.split('#')[0] + '#' + hashedSource;
};

ui.popHash = function () {
  if (window.location.hash && window.location.hash.length > 1) {
    var source = decodeURIComponent(window.location.hash.substr(1));
    window.location.hash = '';
    return source;
  } else {
    return undefined;
  }
};

ui.shareHash = function () {
  var href = ui.getHash();
  var html = "<iframe width='480' height='240' src='" + href + "'></iframe>";

  $('#shareBoxCopied').hide();
  $('#shareBox').fadeIn(100);
  $('#shareBoxText').val(href).focus().select();
  $('#shareBoxHtml').val(html);

  if (window.clipboardData) {
    window.clipboardData.setData(href);
    $('#shareBoxCopied').show();
  }
}

//------------------------------------------------------------------------------
// Hiding

// these cycle between 3 states

ui.showEditor = function (speed) {
  if (speed == undefined) speed = 'fast';

  $('#showEditor').hide();
  $('#hideEditor').hide();
  $('#editor').fadeIn(speed);
  $('#toolbar').fadeIn(speed);
  $('#source').focus();
};

ui.hideToolbar = function (speed) {
  if (speed == undefined) speed = 'fast';

  $('#showEditor').hide();
  $('#toolbar').fadeOut('fast');
  $('#hideEditor').show();
};

ui.hideEditor = function (speed) {
  if (speed == undefined) speed = 'fast';

  $('#hideEditor').hide();
  $('#toolbar').hide();
  $('#editor').fadeOut(speed);
  $('#showEditor').show();
};

//------------------------------------------------------------------------------
// Main

ui.blink = function ($button) {
  $button.css({opacity:0}).animate({opacity:1},'fast');
};

$(window).keydown(function (event) {
      switch (event.which) {

        // PAUSE = pause/resume running
        case 19:
          live.toggleRunning();
          event.preventDefault();
          break;

        // ESCAPE = hold/continue compiling
        case 27:
          live.toggleCompiling();
          event.preventDefault();
          break;

        // CTRL+S to save
        case 115: // WTF?
        case 83:
          if (!event.ctrlKey) break;
        case 19: // cmd+S on mac
          ui.blink($('#save'));
          ui.saveScript();
          event.preventDefault();
          break;

        // CTRL+O to show gallery
        case 79:
          if (!event.ctrlKey) break;
        //case ???: // cmd+O on mac
          ui.blink($('#showGallery'));
          $('#gallery').fadeToggle('fast');
          event.preventDefault();
          break;

        // F1 = show help
        case 112:
          ui.blink($('#showHelp'));
          $('#about').hide();
          $('#help').toggle();
          event.preventDefault();
          break;

        default: // ignore
      }
    });

$(document).ready(function() {

  try {
    var have = Modernizr;
    assert(have.canvas, 'Browser does not support canvas element');
    assert(have.opacity, 'Browser does not support opacity');
    assert(have.rgba, 'Browser does not support rgba() color attributes');
    assert(have.localstorage, 'Browser does not support localStorage');
    assert(have.audio, 'Browser does not support audio element');
    //assert(has.webworkers, 'Browser does not support Web Workers');
    //assert(has.svg, 'Browser does not support svg');
  }
  catch (e) {
    var message = $(document.createElement('h1'))
      .html(String(e))
      .attr('class','warning');
    $(document.body).empty().html(message);
    return;
  }

  // build editor

  $('#source').on('focus', function(){
        $('#gallery').fadeOut('fast');
        $('#shareBox').fadeOut(100); 
        $('#about').fadeOut('fast');
        $('#help').fadeOut('fast');
      });

  $('#showEditor').click(ui.showEditor);
  $('#hideEditor').click(ui.hideEditor);
  $('#hideToolbar').click(ui.hideToolbar);

  $('#save').click(ui.saveScript);
  $('#showGallery').click(function(){ $('#gallery').fadeToggle('fast'); });
  $('#share').click(ui.shareHash);

  $('#showHelp').click(function(){
        $('#about').hide();
        $('#help').fadeToggle(100);
      });
  $('#help').click(function(){ $('#help').fadeToggle(100); });
  $('#showAbout').click(function(){
        $('#help').hide();
        $('#about').fadeToggle(100);
      });

  // initialize

  var initSource = ui.popHash();
  ui.listScripts();

  // hide controls if window is an iframe
  if (window.location != window.parent.location) {
    ui.hideEditor(0);
  } else {
    ui.showEditor(0);
  }

  live.init($('#source'), $('#log'), initSource);
});

</script>
<!-- ------------------------------------------------------------------------ -->
<style>

body,
button {
  color: white;
  background-color: black;
  font-size: medium;
  font-family: helvetica, verdana, sans;
}

body {
  width:  100%;
  height: 100%;
  margin: 0px;
}

.warning { color: red; }

canvas {
  position: fixed; 
  top: 0px;
  left: 0px;
}

#editor textarea {
  position: fixed;
  font-weight: bold;
  font-size: large;
  text-shadow: 1px 1px 0ex black,
               1px -1px 0ex black,
               -1px 1px 0ex black,
               -1px -1px 0ex black;

  margin: 0px;
  padding: 0px;
  border: 0px;
  outline: none;
  resize: none;
  overflow: auto; 

  background-color: rgba(0,0,0,0);
  opacity: 0.5;
}
#source {
  top: 0%;
  bottom: 2ex;
  width: 99%; /* HACK */
  left: 1%;

  color: #aaffaa;
}
#log {
  height: 10ex;
  bottom: 2ex;
  width: 99%; /* HACK */
  left: 1%;

  color: #ffff00;
}

.info {
  position: absolute;
  width: 80%;
  left: 10%;
  top: 0px;

  font-size: medium;

  text-align: center;
  background-color: #222222;
  opacity: 1;

  display: none; /* initially */
}
.info p {
  text-align: left;
}
.info a,
.info a:visited {
  color: #aaaaff; text-decoration: none;
}
.info h1,
.info h2 {
  color: #aaaaaa;
  font-weight: bold;
}

dl {
  text-align: left;
}
dt {
  float: left;
  clear: left;
  padding: 0.5em;
  text-align: right;
  font-weight: bold;
  color: green;
}
#help dt { width: 8em; }
#about dt { width: 14em; }
dd {
  margin: 0 0 0 110px;
  padding: 0.5em;
}

.toolbar {
  margin: 2px;
  position: fixed;
  bottom: 0px;
  left: 0px;
  opacity: 1;
  display: none; /* initially */
}

button {
  margin: 2px;
  border: none;
  border-radius: 10px;
  background-color: #444444;
}
button:hover {
  color: white;
  background-color: #666666;
}
button.roundRound {
  border-top-left-radius:     10px;
  border-bottom-left-radius:  10px;
  border-top-right-radius:    10px;
  border-bottom-right-radius: 10px;
  padding-left:  0.7em;
  padding-right: 0.7em;
}
button.roundFlat {
  border-top-left-radius:     10px;
  border-bottom-left-radius:  10px;
  border-top-right-radius:    2px;
  border-bottom-right-radius: 2px;
  padding-left:  0.7em;
  padding-right: 0.5em;
}
button.flatRound {
  border-top-left-radius:     2px;
  border-bottom-left-radius:  2px;
  border-top-right-radius:    10px;
  border-bottom-right-radius: 10px;
  padding-left:  0.5em;
  padding-right: 0.7em;
}
button.flatFlat {
  border-top-left-radius:     2px;
  border-bottom-left-radius:  2px;
  border-top-right-radius:    2px;
  border-bottom-right-radius: 2px;
  padding-left:  0.5em;
  padding-right: 0.5em;
}

code, pre {
  font-size: medium;
  margin: 0px;
  border: 0px;
}
#gallery {
  background-color: black;
  display: none;

  /* FIXME this does not work */
  max-height: 66%;
  overflow: auto;
}
#gallery tr td {
  padding: 0px 0.25em 0px 0.25em;
  vertical-align: top;
}

#shareBox {
  position: fixed;
  top: 10%;
  left: 10%;

  font-size: x-large;

  background-color: #222222;
  border: solid 12px #222222;
  border-radius: 18px;
  opacity: 1;
  display: none; /* initially */
}
#shareBox textarea {  
  overflow: hidden;
  height: 5.2ex;

  font-family: helvetica, verdana, sans;
  font-weight: bold;
  font-size: large;
}
#shareBox button {
  width: 40%;
  font-size: x-large;
}

/* back-to-front */
canvas { z-index: 1; }
#log { z-index: 2; }
#source { z-index: 4; }
.toolbar { z-index: 5; }
#shareBox { z-index: 6; }
#about { z-index: 7; }
#help { z-index: 8; }

</style>
</head>
<!-- ------------------------------------------------------------------------ -->
<body>

<canvas id='canvas2d'></canvas>

<div id='editor'>
  <textarea id='source' spellcheck='false'></textarea>
  <textarea id='log' readonly spellcheck='false'></textarea>
</div>

<div class='toolbar' id='showEditor'> <button>+</button> </div>
<div class='toolbar' id='hideEditor'> <button>x</button> </div>
<div class='toolbar' id='toolbar'>
  <table id='gallery'> </table>

  <button id='hideToolbar' class='roundRound'>hide</button>
  &nbsp;
  <button class='roundFlat' id='save' title='shortcut = CTRL+S'>save</button><!--
  --><button class='flatFlat' id='showGallery' title='shortcut = CTRL+O'>gallery</button><!--
  --><button class='flatRound' id='share'>share</button>
  &nbsp;
  <button class='roundFlat' id='showHelp' title='shortcut = F1'>help</button><!--
  --><button class='flatRound' id='showAbout'>about</button>
</div>

<div id='shareBox'>
  Share this link with friends:
  <br />
  <textarea id='shareBoxText' rows=2 cols=48 readonly spellcheck='false'></textarea>
  <br />
  Embed this HTML in another page:
  <br />
  <textarea id='shareBoxHtml' rows=2 cols=48 spellcheck='false'></textarea>
  <br />
  <span id='shareBoxCopied'>Copied to clipboard!</span>
</div>

<!-- ------------------------------------------------------------------------ -->
<div class='info' id='help'>
  <h1>What is LiveCoder.net</h1>
  <p>
  LiveCoder.net is a simple browser-based environment for live-coding in a dialect of javascript.
  </p>

  <h1>Keyboard Shortcuts</h1>
  <dl>   
    <dt>PAUSE</dt> <dd>pause/resume running main loop.</dd>
    <dt>ESCAPE</dt>
      <dd>
        hold/continue compiling code
        (useful for atomic modifications to code).
        green = holding, gray = continuing.
      </dd>

    <dt>CTRL+S</dt> <dd>save the current code locally.</dd>
    <dt>CTRL+O</dt> <dd>show list of current scripts.</dd>

    <dt>F1</dt> <dd>show/hide help (this message).</dd>
  </dl>
</div>

<!-- ------------------------------------------------------------------------ -->
<div class='info' id='about'>
  <h1>Inspiration &amp; Related Projects</h1>
  <dl>
    <!--
    <dt><a href=''></a></dt>
      <dd></dd>
    -->
    <dt><a href='http://www.toplap.org'>TOPLAP</a></dt>
      <dd>an organization dedicated to live coding of art</dd>
    <dt><a href='http://impromptu.moso.com.au'>Impromptu</a></dt>
      <dd>a live coding IDE for video and audio</dd>
    <dt><a href='http://www.lively-kernel.org'>Lively Kernel</a></dt>
      <dd>an early experiment in browser-as-platform</dd>
    <dt><a href='http://www.sexyvisuals.com/'>SexyVisuals</a></dt>
      <dd>a band of visual live coders who converted some of their material to webgl</dd>
    <dt><a href='http://mrdoob.com/projects/voxels'>mrdoob's voxels</a></dt>
      <dd>a WebGL demo of MineCraft-style block building</dd>
    <dt><a href='http://coffeescript.org'>coffeescript</a></dt>
      <dd>
        a programming langauge with javascript semantics but cleaner syntax
        (compiles to javascript in a browser)
      </dd>
    <dt><a href='http://creationix.com/jack/public/index.html'>Jack</a></dt>
      <dd>another programming language that cleans up and compiles to javascript</dd>
    <dt><a href='http://codemirror.net'>codemirror.net</a></dt>
      <dd>a browser-based code editor supporting e.g. javascript and coffeescript</dd>
    <dt><a href='http://code.google.com/p/oflivecoding/'>OFLiveCoding</a></dt>
      <dd>a javascript live-coding framework developed with openframeworks</dd>
    <dt><a href='http://paperjs.org'>paper.js</a></dt>
      <dd>a vector graphics library with a sexy demo</dd>
    <dt><a href='https://github.com/christopherdebeer/speak.js'>speak.js</a></dt>
      <dd>a voice synthesizer running in javascript (even on chrome)</dd>
    <dt><a href='http://jsbeautifier.org'>jsbeautifier.org</a></dt>
      <dd>a javascript style beautifier (including lexer)</dd>
    <dt><a href='http://playground.html5rocks.com'>playground.html5rocks</a></dt>
      <dd>a browser-based playground for learning HTML5 and javascript</dd>
    <dt><a href='http://www.htmlfivewow.com/demos/terminal/terminal.html'>html5wow terminal</a></dt>
      <dd>a browser-based terminal emulator</dd>
  </dl>
</div>

</body>
</html>

